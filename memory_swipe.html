<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∏—Ä –ö–∞–ø–∏–±–∞—Ä—ã</title>
    <!-- Include Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animation for card entry */
        @keyframes fly-in {
            from {
                transform: translate(100%, -100%) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
        }

        .card-animate-in {
            animation: fly-in 0.17s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* New animation for correct answer, flying straight down */
        @keyframes fly-out-down {
            from {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            to {
                transform: translate(0, 100%) scale(0.5);
                opacity: 0;
            }
        }

        .card-animate-out-correct-left {
            animation: fly-out-down 0.1s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }

        /* Animation for correct answer, flying out to the right */
        @keyframes fly-out-right {
            from {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            to {
                transform: translate(100%, 100%) scale(0.5);
                opacity: 0;
            }
        }

        /* New animation for correct right answer (burst) */
        @keyframes burst-out-correct {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                filter: blur(0px);
            }
            100% {
                transform: scale(2.5) rotate(720deg);
                opacity: 0;
                filter: blur(10px);
            }
        }

        .card-animate-out-correct-right-burst {
            animation: burst-out-correct 0.2s ease-in forwards;
        }

        /* New animation for incorrect answer */
        @keyframes fade-out-incorrect {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0.7);
                opacity: 0;
            }
        }

        .card-animate-out-incorrect {
            animation: fade-out-incorrect 0.15s ease-out forwards;
        }

        /* Positive particle animations */
        @keyframes star-burst-small {
            from { transform: translate(0, 0) scale(0); opacity: 1; }
            to { transform: translate(var(--x), var(--y)) scale(1.5); opacity: 0; }
        }
        @keyframes star-burst-medium {
            from { transform: translate(0, 0) scale(0); opacity: 1; }
            to { transform: translate(var(--x), var(--y)) scale(1.2); opacity: 0; }
        }
        @keyframes star-burst-large {
            from { transform: translate(0, 0) scale(0); opacity: 1; }
            to { transform: translate(var(--x), var(--y)) scale(1.8); opacity: 0; }
        }

        .particle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            will-change: transform, opacity;
        }

        /* New styling for game container with image */
        #game-container {
            background-image: url('https://media.istockphoto.com/id/1160720443/vector/abstract-simple-geometric-vector-seamless-pattern-with-gold-line-texture-on-white-background.webp?b=1&s=612x612&w=0&k=20&c=ejtl-XXAFVsHcjNbaxdiT4xzzs5bGtA_CUYkO9ZQ-Jk=');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center bg-gray-100 p-4">

<!-- Game Container -->
<div id="game-container" class="w-full max-w-sm h-full max-h-[600px] flex flex-col justify-between items-center bg-white rounded-3xl shadow-2xl p-6 relative overflow-hidden">

    <!-- Header with Mute, Score and Timer -->
    <div class="w-full flex justify-between items-start mb-6">
        <!-- Left-aligned container for mute button -->
        <button id="mute-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-full shadow-md transition-colors duration-200">
            üîä
        </button>
        <!-- Right-aligned container for score and timer -->
        <div class="flex flex-col items-end">
            <div id="score-display" class="text-3xl font-bold text-gray-800">–°—á—ë—Ç: 0</div>
            <div id="timer-display" class="text-xl font-bold text-red-500">5.0</div>
        </div>
    </div>

    <!-- Card Display Area -->
    <div class="relative w-full h-full flex items-center justify-center mb-12">
        <div id="card-display" class="text-[12rem]"></div>
        <!-- Container for positive effects -->
        <div id="effect-container" class="absolute inset-0 z-10 pointer-events-none"></div>
    </div>

    <!-- Control Buttons -->
    <div class="w-full flex justify-center space-x-4 mb-4">
        <button id="left-button" class="flex-1 bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-4 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 active:scale-100">
            –ù–æ–≤—ã–π
        </button>
        <button id="right-button" class="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-4 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 active:scale-100">
            –ü–æ–≤—Ç–æ—Ä
        </button>
    </div>

    <!-- Overlay for Start/Game Over -->
    <div id="overlay" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-center p-8 transition-opacity duration-300 z-20">
        <h2 id="overlay-text" class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-4">–ü–∏—Ä –ö–∞–ø–∏–±–∞—Ä—ã</h2>
        <p id="overlay-subtext" class="text-lg md:text-xl text-gray-600 mb-8">–ü—Ä–æ–≤–µ–¥–∏ –≤–ª–µ–≤–æ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π —Ñ—Ä—É–∫—Ç, –≤–ø—Ä–∞–≤–æ ‚Äî –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª.</p>
        <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
            –ù–∞–∫–æ—Ä–º–∏—Ç—å –ö–∞–ø–∏
        </button>
    </div>
</div>

<!-- Background Music -->
<audio id="background-music" src="https://storage.googleapis.com/corpusant-app-public/riffs/4213a202-c6e6-4ab5-987e-6f8c4aeaedf9/audio/ce8a21ee-1f28-465e-b3da-598e2e43b702.m4a" loop></audio>

<script>
    // Telegram Web Apps integration
    if (window.Telegram) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    }

    // DOM elements
    const gameContainer = document.getElementById('game-container');
    const scoreDisplay = document.getElementById('score-display');
    const timerDisplay = document.getElementById('timer-display');
    const cardDisplay = document.getElementById('card-display');
    const leftButton = document.getElementById('left-button');
    const rightButton = document.getElementById('right-button');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlay-text');
    const overlaySubtext = document.getElementById('overlay-subtext');
    const startButton = document.getElementById('start-button');
    const effectContainer = document.getElementById('effect-container');
    const backgroundMusic = document.getElementById('background-music');
    const muteButton = document.getElementById('mute-button');

    // Game state
    let score = 0;
    let gameActive = false;
    let timeRemaining = 5.0; // –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è
    let timerInterval = null;
    let timeout = null;
    let seenCards = [];
    let currentCard = null;
    let isRepeated = false;
    let lastAnswerTime = performance.now();
    let isMuted = false; // New state variable
    let isFirstTurn = true; // Flag for the very first turn

    // Emojis for the game
    const emojis = ['üçá', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'üçé', 'üçê', 'ü•ù', 'ü•≠', 'üçí', 'üçì', 'ü•ë', 'ü•ï', 'ü•î', 'üå∂Ô∏è', 'üåΩ', 'üçÑ', 'ü•ú'];

    // Timer settings
    const timeLimit = 5000; // 5 —Å–µ–∫—É–Ω–¥
    const timerUpdateInterval = 250; // 250 milliseconds

    // Start button handler
    startButton.addEventListener('click', startGame);
    // Mute button handler
    muteButton.addEventListener('click', () => {
        if (backgroundMusic.paused) {
            backgroundMusic.play();
            muteButton.textContent = 'üîä';
            isMuted = false;
        } else {
            backgroundMusic.pause();
            muteButton.textContent = 'üîá';
            isMuted = true;
        }
    });

    // MainButton functionality
    if (window.Telegram) {
        Telegram.WebApp.MainButton.setText("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—á—ë—Ç–æ–º");
        Telegram.WebApp.MainButton.onClick(function() {
            // Show a popup to confirm sharing
            Telegram.WebApp.showPopup({
                title: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º?',
                message: `–í–∞—à —Å—á—ë—Ç: ${score}. –•–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –≤ —á–∞—Ç?`,
                buttons: [
                    { id: 'share', type: 'default', text: '–î–∞' },
                    { id: 'cancel', type: 'cancel' }
                ]
            }, (buttonId) => {
                if (buttonId === 'share') {
                    // Send message with score to the user's chat
                    const shareMessage = `–Ø –Ω–∞–∫–æ—Ä–º–∏–ª –ö–∞–ø–∏ –∏ –Ω–∞–±—Ä–∞–ª ${score} –æ—á–∫–æ–≤! –°–º–æ–∂–µ—à—å –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∫–æ—Ä–¥?`;
                    Telegram.WebApp.sendData(JSON.stringify({ text: shareMessage }));
                }
            });
        });
        // Hide the button initially
        Telegram.WebApp.MainButton.hide();
    }

    // Input handlers
    document.addEventListener('keydown', (e) => {
        if (!gameActive) return;
        if (e.key === 'ArrowLeft') handleInput('left');
        if (e.key === 'ArrowRight') handleInput('right');
    });
    leftButton.addEventListener('click', () => { if (gameActive) handleInput('left'); });
    rightButton.addEventListener('click', () => { if (gameActive) handleInput('right'); });

    // Touch swipe handling
    let touchstartX = 0;
    let touchendX = 0;
    gameContainer.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX;
    }, false);
    gameContainer.addEventListener('touchend', e => {
        touchendX = e.changedTouches[0].screenX;
        handleGesture();
    }, false);
    function handleGesture() {
        if (!gameActive) return;
        if (touchendX < touchstartX - 50) handleInput('left');
        if (touchendX > touchstartX + 50) handleInput('right');
    }

    // Main game functions
    function startGame() {
        score = 0;
        seenCards = [];
        gameActive = true;
        isFirstTurn = true; // Reset the flag for a new game
        overlay.classList.add('opacity-0', 'pointer-events-none');
        updateScore();
        if (!isMuted) {
            backgroundMusic.play().catch(error => {
                console.error("Autoplay failed:", error);
            });
        }
        // Hide the Telegram Main Button when the game starts
        if (window.Telegram) {
            Telegram.WebApp.MainButton.hide();
        }
        gameLoop();
    }

    function endGame(reason) {
        gameActive = false;
        clearInterval(timerInterval);
        clearTimeout(timeout);
        overlayText.textContent = reason;
        overlaySubtext.innerHTML = `–í–∞—à —Å—á—ë—Ç: <span class="font-bold text-blue-600">${score}</span> –æ—á–∫–æ–≤.`;
        startButton.textContent = '–ü–æ–∫–æ—Ä–º–∏—Ç—å –µ—â—ë —Ä–∞–∑';
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        // Show the Telegram Main Button when the game ends
        if (window.Telegram) {
            Telegram.WebApp.MainButton.show();
        }
    }

    function createPositiveEffect() {
        const particleCount = 10;
        const particles = ['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üåà'];
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.textContent = particles[Math.floor(Math.random() * particles.length)];
            particle.classList.add('particle', 'text-4xl');

            const randomX = (Math.random() - 0.5) * 200;
            const randomY = (Math.random() - 0.5) * 200;
            const duration = 0.8 + Math.random() * 0.4;
            const animationClass = ['star-burst-small', 'star-burst-medium', 'star-burst-large'][Math.floor(Math.random() * 3)];

            particle.style.setProperty('--x', `${randomX}px`);
            particle.style.setProperty('--y', `${randomY}px`);
            particle.style.animation = `${animationClass} ${duration}s ease-out forwards`;

            effectContainer.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, duration * 1000);
        }
    }

    function handleInput(direction) {
        let correct = false;
        let animationClass = '';
        let isCorrectRepeatRight = false;

        // Special case for the very first turn.
        if (isFirstTurn) {
            correct = true;
            animationClass = 'card-animate-out-correct-left'; // Always use the left animation
            isFirstTurn = false; // Turn off the flag
        } else if (direction === 'left' && !isRepeated) {
            correct = true;
            animationClass = 'card-animate-out-correct-left';
        } else if (direction === 'right' && isRepeated) {
            correct = true;
            isCorrectRepeatRight = true;
            animationClass = 'card-animate-out-correct-right-burst';
        } else {
            animationClass = 'card-animate-out-incorrect';
        }

        if (correct) {
            // Add haptic feedback for correct answer
            if (window.Telegram && Telegram.WebApp.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }

            // Calculate score based on time remaining
            const timeTaken = performance.now() - lastAnswerTime;

            let points;
            const gracePeriod = 300; // in milliseconds
            const maxPoints = Math.floor(timeLimit / 5);

            if (timeTaken <= gracePeriod) {
                points = maxPoints;
            } else {
                const timeRemaining = Math.max(0, timeLimit - timeTaken);
                points = Math.floor(timeRemaining / 5);
            }

            score += points;

            updateScore();
            createPositiveEffect(); // Call the new function
            cardDisplay.classList.add(animationClass);

            // Set different timeouts for different animations
            const timeoutDuration = isCorrectRepeatRight ? 200 : 100;

            setTimeout(() => {
                cardDisplay.classList.remove(animationClass);
                gameLoop();
            }, timeoutDuration);
        } else {
            // Add haptic feedback for incorrect answer
            if (window.Telegram && Telegram.WebApp.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }

            animationClass = 'card-animate-out-incorrect';
            let reason = '';
            if (direction === 'left' && isRepeated) {
                reason = '–Ø —ç—Ç–æ —É–∂–µ –µ–ª–∞!';
            } else if (direction === 'right' && !isRepeated) {
                reason = '–≠–π! –Ø —ç—Ç–æ –µ—â–µ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª–∞!';
            } else {
                reason = '–ö–∞–ø–∏ —É—Å–Ω—É–ª–∞...';
            }

            setTimeout(() => {
                endGame(reason);
                cardDisplay.classList.remove(animationClass);
            }, 150);
        }
    }

    function gameLoop() {
        if (!gameActive) return;

        clearInterval(timerInterval);
        clearTimeout(timeout);
        timeRemaining = 5.0;
        updateTimer();
        lastAnswerTime = performance.now();

        const shouldRepeat = seenCards.length > 0 && Math.random() < 0.5;
        isRepeated = shouldRepeat;
        if (shouldRepeat) {
            currentCard = seenCards[Math.floor(Math.random() * seenCards.length)];
        } else {
            const availableEmojis = emojis.filter(e => !seenCards.includes(e));
            if (availableEmojis.length === 0) {
                endGame('–ö–∞–ø–∏ –Ω–∞–µ–ª–∞—Å—å!');
                return;
            }
            currentCard = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
            seenCards.push(currentCard);
        }

        cardDisplay.textContent = currentCard;
        cardDisplay.classList.add('card-animate-in');
        setTimeout(() => {
            cardDisplay.classList.remove('card-animate-in');
        }, 170);

        let startTime = performance.now();
        timerInterval = setInterval(() => {
            const elapsedTime = performance.now() - startTime;
            timeRemaining = Math.max(0, 5 - (elapsedTime / 1000));
            updateTimer();
        }, timerUpdateInterval);

        timeout = setTimeout(() => {
            if (gameActive) {
                endGame('–ö–∞–ø–∏ —É—Å–Ω—É–ª–∞...');
            }
        }, timeLimit);
    }

    function updateScore() {
        scoreDisplay.textContent = `–°—á—ë—Ç: ${score}`;
    }

    function updateTimer() {
        timerDisplay.textContent = timeRemaining.toFixed(1);
    }
</script>
</body>
</html>
